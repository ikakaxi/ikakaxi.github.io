title: 微信支付中的坑及解决办法
author: superman
date: 2018-02-07 22:33:06
categories:
- android
tags:
- 支付
---

这几天做微信支付遇到很多坑,官方的demo跑不起来,首先这个demo隐藏的很深...很难找到那个支付的demo,而且你找到以后还有错误,因为代码里引入的包都是sdk什么什么,但是他自己带的jar包实际的包名是opensdk什么什么,你改过来之后就算运行起来也调不起微信,因为这个demo里的url已经无法访问了...
<!--more-->
然后网上查资料,用网上的各种办法终于解决了,现在总结一下,你用我的办法肯定能解决微信支付的问题
#####坑1:调不起微信
首先,你要保证服务器返回的参数都正确,如果参数不正确的话肯定调用不起来,这里假设参数是正确的.支付的appid可以在客户端保存也可以在服务器返回,这里我用服务器返回的做示例,步骤如下:
1.调用支付的Activity中,实例化IWXAPI
```
public class MainActivity extends Activity {

	private IWXAPI api;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		//在这里可以不传AppId传null就可以
		api = WXAPIFactory.createWXAPI(this, null);
	}

	//payParamResponse是我封装的服务器返回的参数
	private void startPay(PayParamResponse payParamResponse){
		PayReq req = new PayReq();
		req.appId = payParamResponse.getAppid();
		req.nonceStr = payParamResponse.getNoncestr();
		req.packageValue = "Sign=WXPay";
		req.partnerId = payParamResponse.getPartnerid();
		req.prepayId = payParamResponse.getPrepayid();
		req.timeStamp = payParamResponse.getTimestamp();
		req.sign = payParamResponse.getSign();
		//在sendReq方法发起支付之前需要注册你的AppId
		api.registerApp(payParamResponse.getAppid());
		api.sendReq(req);
	}
 
}
```
2.从服务器获取到支付参数后调用startPay即可调起微信来支付
#####坑2:找不到WXPayEntryActivity类
因为现在都是用android studio开发了,而且大部分都用到了多渠道打包,所以你们是不是遇到了回调找不到WXPayEntryActivity类的bug?
不得不说微信支付sdk太傻比,这里有这几种情况
假设manifest的package为A,build.gradle的applicationId为B
>1:WXPayEntryActivity的activity:name的包名为".wxapi.WXPayEntryActivity"(注意最前面有个".")
2:WXPayEntryActivity的activity:name的包名为"A.wxapi.WXPayEntryActivity"(这次是"A.")
3:WXPayEntryActivity的activity:name的包名为"B.wxapi.WXPayEntryActivity"(这次是"B.")(建议写为"${applicationId}.wxapi.WXPayEntryActivity")

第一种情况下还有2种情况:(.wxapi.WXPayEntryActivity)
1.A为微信平台注册的包名,这时候支付后(不管成功与否),可以跳转到WXPayEntryActivity页面
1.B为微信平台注册的包名,这时候支付后(不管成功与否),只会回到支付前的页面,无法跳转到WXPayEntryActivity页面(反编译apk会发现WXPayEntryActivity的路径为A.wxapi.WXPayEntryActivity,而A并不是微信平台注册的包名)

第二种情况下也是还有2种情况:(A.wxapi.WXPayEntryActivity)
1.A为微信平台注册的包名,这时候支付后(不管成功与否),可以跳转到WXPayEntryActivity页面
1.B为微信平台注册的包名,这时候支付后(不管成功与否),只会回到支付前的页面,无法跳转到WXPayEntryActivity页面(因为这时候WXPayEntryActivity的路径为A.wxapi.WXPayEntryActivity,而A并不是微信平台注册的包名)

第三种情况下也是还有2种情况:(B.wxapi.WXPayEntryActivity)
1.A为微信平台注册的包名,这时候支付后(不管成功与否),无法跳转到WXPayEntryActivity页面(因为这时候WXPayEntryActivity的路径为B.wxapi.WXPayEntryActivity,而B并不是微信平台注册的包名)
1.B为微信平台注册的包名,这时候支付后(不管成功与否),可以跳转到WXPayEntryActivity页面

上面说的比较详细,其实我估计微信是通过你的AppId能在微信平台查到你的包名,然后startActivity的时候传递的是"包名.wxapi.WXPayEntryActivity",如果路径错了他就查不到这个类所以就跳转失败

#####所以现在我的解决办法是,有几个productFlavors(我的每个productFlavors都有一个applicationId),就对应建立applicationId.wxapi包名的文件夹然后放入WXPayEntryActivity,建议可以写个类去实现IWXAPIEventHandler接口,比如这个实现IWXAPIEventHandler接口的类名叫AClass,然后你的几个wxapi包下建立WXPayEntryActivity继承AClass就可以了,AClass的实现直接拷贝之前的WXPayEntryActivity里面的代码就行,继承AClass的子类里面不需要任何代码

#####然后我再贴一下WXPayEntryActivity类
```
public class WXPayEntryActivity extends Activity implements IWXAPIEventHandler {

	private static final String TAG = "MicroMsg.SDKSample.WXPayEntryActivity";

	private IWXAPI api;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.pay_result);
		api = WXAPIFactory.createWXAPI(this, null);
		//这里可以不注册appId
		api.handleIntent(getIntent(), this);
	}

	@Override
	protected void onNewIntent(Intent intent) {
		super.onNewIntent(intent);
		setIntent(intent);
		api.handleIntent(intent, this);
	}

	@Override
	public void onReq(BaseReq req) {
		Log.e("onReq:", "req=" + req);
	}

	@Override
	public void onResp(final BaseResp resp) {
		Log.d("resp:", "code=" + resp.errCode + ",str=" + resp.errStr);
		if (resp.getType() == ConstantsAPI.COMMAND_PAY_BY_WX) {
			switch (resp.errCode) {
				case 0: {
					Toast.makeText(WXPayEntryActivity.this, "支付成功", Toast.LENGTH_SHORT).show();
					break;
				}
				case -1: {
					Toast.makeText(WXPayEntryActivity.this, "发生错误\t可能的原因：签名错误、未注册APPID、项目设置APPID不正确、注册的APPID与设置的不匹配、其他异常等。", Toast.LENGTH_SHORT).show();
					break;
				}
				case -2: {
					Toast.makeText(WXPayEntryActivity.this, "用户取消支付", Toast.LENGTH_SHORT).show();
					break;
				}
			}
		}
	}
}
```